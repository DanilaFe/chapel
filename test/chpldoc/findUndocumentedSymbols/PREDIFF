#!/usr/bin/env bash

TESTNAME=$1
OUTFILE=$2
SCRIPT_OUTFILE=$TESTNAME.script.tmp
TMPFILE=$OUTFILE.prediff.tmp


SCRIPT=$CHPL_HOME/tools/undocumentedSymbols/findUndocumentedSymbols
PREDIFF_OPTS_FILE=$TESTNAME.prediffopts
PREDIFF_OPTS=
if [ -f $PREDIFF_OPTS_FILE ]; then
  # read the first line from script opts file
  PREDIFF_OPTS=`head -n 1 $PREDIFF_OPTS_FILE`
fi

(set -x && $SCRIPT $PREDIFF_OPTS $TESTNAME.chpl &> $SCRIPT_OUTFILE)

cat $SCRIPT_OUTFILE >$TMPFILE

if [ -s $OUTFILE ]; then
  # if there is no output, no need to do this
  echo "================================================================================" >>$TMPFILE
  cat $OUTFILE >>$TMPFILE
fi
mv $TMPFILE $OUTFILE
rm $SCRIPT_OUTFILE
