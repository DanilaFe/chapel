.. _readme-chpl-language-server:

chpl-language-server
====================

``chpl-language-server`` (``CLS`` for short) is a language intelligence tool
for the Chapel programming language. ``CLS`` provides many of the common
features users expect from a modern development environment. It is built on top
of the `Language Server Protocol (LSP)
<https://microsoft.github.io/language-server-protocol/>`_ and is designed to be
editor-agnostic.

Getting Started
---------------

The easiest way to make ``CLS`` available ``chpl-language-server`` Makefile
target. This will build the Dyno compiler frontend and the Python bindings for
Dyno if needed, and place ``chpl-language-server`` into ``$CHPL_HOME/bin``. In
from-source builds, this directory should already be in your ``PATH``; this
means you should be invoke ``chpl-language-server`` from the command-line
without any additional work.

``CLS`` can be used with any editor that supports the Language Server Protocol
(LSP). Listed below are setup instructions for some popular editors. If your
preferred editor is not listed, consider opening an issue or pull request to
add it.

Neovim
^^^^^^

In Neovim, the built-in LSP API can be used to configure ``CLS`` as
follows:

.. code-block:: lua

   local lspconfig = require 'lspconfig'
   local configs = require 'lspconfig.configs'
   local util = require 'lspconfig.util'

   configs.cls = {
     default_config = {
       cmd = {"chpl-language-server"},
       filetypes = {'chpl'},
       autostart = true,
       single_file_support = true,
       root_dir = util.find_git_ancestor,
       settings = {},
     },
   }
   
   lspconfig.cls.setup{}
   vim.cmd("autocmd BufRead,BufNewFile *.chpl set filetype=chpl")


VSCode
^^^^^^

Install the soon-to-be-released ``chapel`` extension from the `Visual Studio
Code marketplace
<https://marketplace.visualstudio.com/items?itemName=chpl-hpe.chapel>`_.

.. note::

   The extension is not yet available at the time of writing and the above link
   may not work until then. This section will be updated when it is available.

Supported Features
------------------

``CLS`` supports a number of core features, with further features controlled by configuration options.

Core Features
^^^^^^^^^^^^^

Optional Features
^^^^^^^^^^^^^^^^^

Experimental Resolver Features
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

All of the following features are disabled without the ``--resolver`` flag. To use them, enable ``--resolver``.

.. warning::

   These features rely on the Dyno resolver, which is not finished and actively
   under development. It is not unexpected for ``--resolver`` to cause ``CLS``
   to crash or hang.

Configuring Chapel Projects
---------------------------

Many Chapel projects are organized in a way that is not immediately understandable bg ``CLS``. For example, a project may have multiple source directories with any variety of build systems (``make``, ``mason``, etc.). ``CLS`` can be configured to understand the structure of a Chapel project by creating a ``.cls-commands.json`` file in the root of the project. This is done automatically when ``chpl-shim`` is used to build a project.

.. note::

   The ``.cls-commands.json`` file is not intended to be edited by hand. It is
   generated by ``chpl-shim`` and should be treated as a build artifact. It is specific to the machine and build environment that generated it.

For example, the following can be used to configure ``CLS`` to understand a project using ``make``:

.. code-block:: bash

   $CHPL_HOME/tools/chpl-language-server/chpl-shim make

This is similarly done for ``mason`` projects:

.. code-block:: bash

   $CHPL_HOME/tools/chpl-language-server/chpl-shim mason build

.. note::

   The above commands assume a from-source build of Chapel. An installed Chapel
   may require a different path to ``chpl-shim``.

.. note::

   First class ``mason`` support is currently planned (but not yet
   implemented), avoiding the need for ``chpl-shim`` in ``mason`` projects.
